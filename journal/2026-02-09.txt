[연구 일지] 2026-02-09
1. 주요 내용
Google Cloud Build 기반의 CI/CD 파이프라인(GitHub 연동) 완벽 구축, IAM 및 Service Account 권한 최적화를 통한 BigQuery 데이터 수집 정상화, 배포 트리거 필터링 적용.

2. 진행 요약
수동 배포의 비효율성을 제거하기 위해 GitHub와 GCP Cloud Build를 연동하여 자동 배포 시스템을 구축함. 이 과정에서 2세대 저장소 연결 및 KMS 암호화 키 생성 문제를 해결함. cloudbuild.yaml을 작성하여 'Docker 이미지 빌드 → Artifact Registry 푸시 → MIG 롤링 업데이트'의 전 과정을 자동화함. 배포 후 발생한 BigQuery 접근 권한(403) 오류를 해결하기 위해 VM의 Service Account에 정확한 IAM 역할을 부여하고, 연구일지 등 문서 수정 시에는 불필요한 배포가 일어나지 않도록 트리거 필터를 최적화함.

3. 주요 수정 및 개발 내용
CI/CD 파이프라인 구축 (DevOps):
GitHub 저장소(Mervis_Project)와 Cloud Build(2세대) 연동 및 트리거(mervis-auto-deploy) 생성.
asia-northeast3 리전의 Cloud KMS 암호화 키(mervis-github-key) 생성 및 연동 보안 강화.

cloudbuild.yaml 작성: 최신 코드를 감지하여 서버 그룹(MIG)을 무중단 교체(Rolling Action)하는 로직 구현.

권한 및 보안 설정 (IAM & Security):
VM이 사용하는 서비스 계정(mervis-compute-sa) 식별 및 권한 재조정.
BigQuery 접근을 위해 roles/bigquery.jobUser 및 roles/bigquery.dataEditor 권한 부여.
CLI(gcloud)를 활용한 신속한 권한 바인딩 처리.

운영 효율화 (Optimization):
Cloud Build 트리거 필터 적용: **/*.md, *.txt 등 문서 파일 수정 시에는 빌드/배포가 유발되지 않도록 예외 처리 설정.
Dockerfile 경로 인식 문제 해결을 위한 빌드 구성 파일 수정.

4. 시행 착오 및 오류 해결 [Cloud Build 저장소 연결 실패]
증상: "Cloud Source Repositories API를 활성화할 수 없습니다" 및 키 누락 에러.
원인: GCP 결제/권한 상태 문제 및 2세대 저장소 연결 시 필수인 KMS 키 미생성.
해결: CLI로 API 강제 활성화 및 gcloud kms 명령어로 암호화 키 링/키 생성 후 연동 성공.

[빌드 실패 (Dockerfile 경로 문제)]
증상: unable to prepare context: ... no such file or directory 에러 발생.
원인: cloudbuild.yaml 내 dir: 'Mervis' 설정으로 인해, 최상위에 위치한 파일을 하위 폴더에서 찾으려 시도함.
해결: dir 옵션을 제거하여 저장소 루트(Root)를 기준으로 빌드하도록 수정.

[BigQuery 데이터 적재 실패 (403 Forbidden)]
증상: 크롤러 실행 시 User does not have bigquery.jobs.create permission 에러 발생.
원인: VM의 Access Scope는 열려있었으나, 실제 실행 주체인 Service Account에 BigQuery 권한이 없었음.
해결: 기본 컴퓨트 계정이 아닌 mervis-compute-sa 계정에 정확히 IAM 권한을 부여하여 해결.

5. 다음 목표
인프라 안정성 테스트 (Chaos Engineering): Spot VM 강제 회수 시뮬레이션 및 MIG 자동 복구 검증.
네트워크 고도화: 로드밸런서(ALB) 도입을 통한 고정 IP 확보 및 보안 강화 (Cloud Armor 준비).
아키텍처 분리: Terraform을 활용하여 '학습용(Training)'과 '서비스용(Serving)' 인프라를 논리적으로 분리하여 배포 영향도 최소화.