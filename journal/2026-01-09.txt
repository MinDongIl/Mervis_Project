[연구 일지] 2026-01-09

1. 주요 내용
머신러닝(ML) 학습 데이터셋 구축을 위한 파이프라인 설계, 야간 자율 주행 크롤러(Nightly Crawler) 개발 및 고속 병렬 처리 최적화.

2. 진행 요약
어제 구축한 하이브리드 모듈 시스템을 기반으로, 실제 시장 전체 데이터(6,300개 종목)를 매일 밤 자동으로 수집하여 BigQuery 데이터 마트에 적재하는 자동화 체계를 완성함. 특히 단순 수집을 넘어, 동전주(Penny Stock)와 소외주를 사전에 걸러내는 '스마트 스킵' 기술과 멀티스레딩을 도입하여 데이터의 질(Quality)을 높이고 수집 속도를 획기적으로 개선함. 이로써 AI 학습을 위한 '정답지 만들기'의 초석을 다짐.

3. 주요 수정 및 개발 내용
ML Feature Engineering 및 DB 스키마 확장

기술적 지표 강화: technical.py를 수정하여 단순 매수 신호뿐만 아니라, AI 학습에 필요한 수치형 데이터(ma20_ratio(이격도), vol_ratio(거래량 비율), vwap_ratio)를 산출하도록 업그레이드.

데이터 적재 로직: mervis_bigquery.py에 save_daily_features 함수를 신설하여 기술/재무/수급 데이터를 통합 저장하는 구조 마련.

고성능 크롤러 개발 (High-Performance Crawler)

병렬 처리(Multi-threading): concurrent.futures를 활용해 Worker Thread를 10개로 확장, 기존 직렬 처리 대비 속도를 약 5~8배 향상시킴.

스마트 스킵(Smart Skip): 모든 종목을 무겁게 분석(yfinance)하는 비효율을 제거. 1차적으로 가벼운 차트 데이터(KIS)를 조회하여 주가 $1 미만, 거래량 5만 주 미만인 종목은 즉시 폐기(Drop)하는 필터링 로직 적용.

안정성 확보: 작업 도중 중단을 위한 Ctrl+C 핸들링 및 일시적 네트워크 오류 무시 로직 추가.

4. 시행 착오 및 오류 해결
[BigQuery 데이터 전송 오류]

증상: save_daily_features 실행 중 Invalid JSON payload received. Unexpected token NaN 에러 발생하며 적재 실패.

원인: Python의 float('nan') 값은 JSON 표준이 아니므로 BigQuery API가 수신을 거부함. 기술적 지표 계산 과정에서 데이터 부족으로 발생한 NaN이 그대로 전달됨.

해결: safe_float 유틸리티 함수를 구현하여 NaN 및 Infinity 값을 강제로 0.0으로 치환(Sanitizing) 후 전송하도록 수정.

[수집 속도 이슈]

문제: 초기 단일 스레드 방식으로 6,300개 종목 순회 시 약 4시간 이상 소요되어 야간 배치 작업으로 부적합.

해결: 스레드 풀(Thread Pool) 도입 및 배치 인서트(Batch Insert, 50개 단위) 적용으로 소요 시간을 40분 내외로 단축.

5. 다음 목표
리그 승격 시스템(League System) 가동: 밤새 수집된 daily_features 데이터를 기반으로, 특정 조건(수급 점수 상위, 이격도 적정 등)을 만족하는 '정예 40 종목'을 추출하는 SQL View 생성.

시스템 연동: 기존의 랜덤 종목 추출 방식을 폐기하고, 크롤러가 선별한 데이터를 머비스의 장전 분석(Pre-market Analysis) 대상 리스트로 자동 연결.

+ 대규모 업데이트 CLI -> GUI

1. 주요 내용
사용자 경험(UX) 혁신을 위한 텍스트 기반(CLI) 시스템의 GUI(Graphical User Interface) 대전환 및 실시간 웹소켓 데이터 시각화 파이프라인 완성.

2. 진행 요약
기존의 텍스트 로그 방식만으로는 실시간 변동성에 대응하기 어렵다는 판단하에, PyQt6 프레임워크를 도입하여 시스템 인터페이스를 전면 개편함. '종목 선별 -> 리스트 등재 -> 웹소켓 구독 -> 차트/호가 실시간 반영'으로 이어지는 데이터 흐름을 시각적으로 구현함. 특히, 백엔드(데이터 처리)와 프론트엔드(화면 표시)를 스레드로 분리하여, 대량의 틱 데이터가 유입되어도 화면이 멈추지 않는 고성능 대시보드 환경을 구축함.

3. 주요 수정 및 개발 내용 GUI 아키텍처 도입 (PyQt6 기반)
메인 윈도우(Main Window): main_gui.py를 신설. 상단 내비게이션 바(Navigation Bar)를 통해 종목(Stock), 차트(Chart), 분석(Analysis), 설정(Settings) 화면을 탭 방식으로 전환하는 QStackedWidget 구조 구현.

실시간 차트 위젯: mplfinance 라이브러리를 Qt 위젯에 임베딩하여, 정적 이미지가 아닌 실시간으로 캔들이 그려지는 RealTimeChartWidget 개발.

실시간 데이터 바인딩 (Data Binding Pipeline)

WebSocket Worker: 백그라운드에서 mervis_state(공유 메모리)를 감시하다가 데이터 변경 시 PyQt Signal(price_updated)을 방출하는 중계 스레드 개발.

구독 자동화: 사용자가 종목 리스트에 종목을 추가하면 즉시 kis_websocket에 구독 요청을 보내고, 삭제 시 구독을 해제하는 양방향 동기화 로직 구현.

사용자 편의 기능

종목 관리: 자동 완성(Completer) 기능이 포함된 검색바와 종목 삭제 버튼(X) 및 확인 팝업 추가.

모드 선택: 프로그램 실행 시 팝업(QInputDialog)을 통해 실전(REAL)/모의(MOCK) 모드를 직관적으로 선택하도록 개선.

4. 시행 착오 및 오류 해결 [차트 로더 인자 오류]

증상: ChartLoader 실행 시 TypeError: get_daily_chart() got an unexpected keyword argument 'period' 발생하며 차트 로딩 실패.

원인: kis_chart 모듈 업데이트 사항을 반영하지 않고, GUI 코드에서 구버전 인자(period)를 사용함.

해결: 인자를 제거하고, 반환된 Raw List 데이터를 ChartLoader 스레드 내부에서 DataFrame으로 변환(Column Renaming 포함)하도록 로직 수정.

5. 다음 목표
별도 윈도우로 분리된 대화형 AI(Chat Window)를 메인 시스템과 유기적으로 연동하거나 통합 검토.

장시간 구동 시 GUI 메모리 점유율 모니터링 및 웹소켓 재연결 안정성 테스트.