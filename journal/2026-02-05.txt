[연구 일지] 2026-02-05

1. 주요 내용
GCP Secret Manager 기반의 보안 체계 구축, 환경 변수 기반 코드 리팩토링, Terraform 및 Docker 배포 트러블슈팅을 통한 클라우드 실전 서버 가동 성공.

2. 진행 요약
지난 연구일지에서 식별된 보안 취약점을 해결하기 위해 민감 정보(API Key, Webhook URL 등)를 코드 파일에서 분리하여 GCP Secret Manager로 이관함. 이에 맞춰 Python 코드를 로컬 파일 참조 방식에서 환경 변수(os.getenv) 참조 방식으로 전면 리팩토링함. Terraform 인프라 코드에 Secret Manager 접근 권한을 부여하고, 서버 부팅 시 비밀 값을 안전하게 주입하는 스크립트를 작성함. 배포 과정에서 발생한 윈도우/리눅스 호환성 문제(CRLF), SSH 접속 문제, Docker 의존성 누락 등을 해결하고, 최종적으로 클라우드 상에서 Mervis 서버가 정상적으로 실행됨을 로그로 검증함.

3. 주요 수정 및 개발 내용
보안 아키텍처 적용 (Security):
- GCP Secret Manager에 6개의 핵심 보안 키(mervis-kis-app-key-real 등) 등록.
- Terraform modules/compute/main.tf에 roles/secretmanager.secretAccessor 권한 추가.
- metadata_startup_script 수정: 서버 부팅 시 Secret Manager에서 값을 호출하여 Docker 컨테이너의 환경 변수(-e)로 주입하는 로직 구현.

코드 리팩토링 (Refactoring):
- Python 소스 코드(kis_auth.py 등) 내 하드코딩된 파일 경로 제거 및 os.getenv를 활용한 유연한 구조로 변경.
- requirements.txt 최적화: 누락된 라이브러리(schedule, pytz) 식별 및 추가.

운영 편의성 개선 (Operations):
- SSH 접속 편의를 위해 고정 SSH 키(mervis-key) 생성 및 Terraform 메타데이터에 등록하여 자동 배포되도록 설정.
- 운영/배포를 위한 필수 명령어 모음(Cheat Sheet) 작성.

4. 시행 착오 및 오류 해결
[Startup Script 실행 불가 (CRLF 문제)]
증상: 서버 부팅 로그에 /bin/bash^M: bad interpreter 에러 발생하며 Docker 설치 스크립트 중단.
원인: 윈도우 환경에서 작성된 스크립트의 줄바꿈 문자(CRLF)를 리눅스(LF)가 인식하지 못함.
해결: VS Code 에디터 설정을 통해 파일 형식을 LF로 변환 후 재배포.

[SSH 접속 및 Host Key 오류]
증상: 인프라 재배포 후 기존 IP로 접속 시 Host key verification failed 경고 발생.
해결: ssh-keygen -R [IP] 명령어로 기존 지문 삭제 및 테라폼에 고정 공개키(ssh-keys)를 등록하여 접속 안정성 확보.

[Docker 컨테이너 실행 실패]
증상: ModuleNotFoundError: No module named 'schedule' 로그 반복 출력.
원인: 로컬 환경과 달리 Docker 이미지 내에 스케줄링 라이브러리 설치가 누락됨.
해결: requirements.txt에 schedule, pytz 추가 후 이미지 재빌드 및 Rolling Update 수행.

5. 다음 목표
기능 무결성 점검 (Sanity Check): Discord 알림 수신, DB 연동 등 외부 통신 기능 검증.
인프라 안정성 테스트 (Chaos Engineering): 실행 중인 VM 강제 종료를 통한 MIG 자동 복구(Auto-healing) 기능 및 데이터 보존 여부 검증.
아키텍처 고도화 계획: 안정적인 매매를 위해 학습용(Training) 자원과 매매용(Inference) 자원을 분리하는 아키텍처 설계 구상.