[연구 일지] 2026-02-11

1. 주요 내용
Terraform을 활용한 학습용/서비스용 인프라 분리 및 비용 최적화(Spot Instance) 적용 완료. 해당 과정에서 발생한 Python 3.12 Docker 환경의 심각한 의존성 충돌 해결 및 GCP IAM/Network 보안 재설정을 통한 서비스 정상화.

2. 진행 요약
운영 효율성을 위해 단일 서버 구조를 '학습용(Training)'과 '서비스용(Serving)'으로 분리하는 Terraform 리팩토링을 진행함.
비용 절감을 위해 Spot Instance(e2-micro/small)를 적용하고, 보안 강화를 위해 Public IP를 제거한 뒤 Cloud NAT를 구성함.
변경된 인프라에 배포하는 과정에서 Python 3.12 환경의 라이브러리(numpy, pandas) 버전 충돌로 빌드가 실패하고, 실행 시 BigQuery 권한 오류가 발생함.
이를 해결하기 위해 pip 최신화 및 의존성 제약 해제 전략(Soft Constraints)을 적용하여 빌드를 성공시킴.
이후 VM Scope 및 IAM 권한을 재조정하여 최종적으로 분리된 인프라에서 크롤링 및 데이터 적재가 정상 작동함을 확인.

3. 주요 수정 및 개발 내용
[Infrastructure (Terraform)]
모듈 분리: compute, network, lb 모듈을 목적(학습/서비스)에 맞게 분리 및 의존성 정리.
비용 최적화: Serving(e2-micro Spot), Training(e2-small Spot)으로 인스턴스 타입 변경.
보안 네트워크: VPC 서브넷 격리, Public IP 제거, Cloud NAT를 통한 외부 통신 및 IAP 터널링 접속 환경 구축.

[Build System (Docker/Python)]
의존성 해결: requirements.txt의 하드 코딩된 버전 제약을 제거하고, pip(26.0.1)와 setuptools를 최신화하여 Python 3.12 호환성 확보.
Dockerfile 최적화: 빌드 도구 업데이트 구문 추가 및 캐시 문제 해결을 위한 명령어 순서 조정.

[Security & Permissions (GCP)]
권한 재설정: VM 인스턴스의 API Access Scope를 'cloud-platform'으로 확장.
IAM 역할 부여: Service Account에 'BigQuery 관리자' 권한을 명시적으로 부여하여 데이터 적재 허용.

4. 시행 착오 및 오류 해결
[인프라 배포 후 Docker 이미지 오류]
증상: Manifest unknown (태그 누락) 및 ModuleNotFoundError (yfinance).
원인: 로컬 빌드 후 Push 누락 및 VM이 구버전 캐시 이미지를 계속 사용함.
해결: Docker Push 수행 및 서버 내 docker rmi -f 명령어로 좀비 이미지 강제 삭제 후 재배포.

[Python 3.12 빌드 의존성 충돌 (Dependency Hell)]
증상: pip install 중 numpy, pandas 버전 충돌로 빌드 실패.
시도: 버전 다운그레이드(Python 3.11, pip 24.x) 등 다수 시도 실패.
해결: "불필요한 제약이 독이다"는 결론 하에 버전 명시를 지우고 pip의 Resolver에 위임하여 해결.

[보안 네트워크 및 권한 접근 거부 (403 Forbidden)]
증상: Private Subnet 적용 후 외부 통신 불가 및 BigQuery Job 생성 권한 없음.
해결: Cloud NAT 구성으로 외부 인터넷 연결 확보. BigQuery 403 에러는 VM Scope 개방과 IAM 권한 부여로 해결.

5. 다음 목표
분리된 인프라(학습/서비스) 환경에서의 24시간 안정성 테스트 (메모리 누수 확인).
Cloud NAT를 통한 데이터 수집 속도 및 비용 모니터링.
고의 장애 주입 및 복구 테스트 (Chaos Engineering): 실무 장애 상황(인스턴스 강제 종료, 네트워크 차단 등)을 가정하여 시스템을 공격하고, 인프라의 자동 복구(Auto-healing) 능력 검증.
장애 대응 시나리오 문서화: 테스트 결과를 수치화(복구 시간, 가용성 등)하여 포트폴리오 및 경험 만들기.