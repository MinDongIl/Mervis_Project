[연구 일지] 2026-02-03

1. 주요 내용
Terraform을 활용한 Google Cloud 인프라(IaC) 구축 및 비용 효율적인 서버 아키텍처(Spot VM + MIG) 설계, Docker 이미지의 원격 저장소(Artifact Registry) 배포 완료.

2. 진행 요약
로컬 환경에서 구동되던 'Mervis'를 클라우드 환경으로 이관하기 위해 Terraform 기반의 인프라 코드를 작성함. 네트워크(VPC), 저장소(Artifact Registry), 컴퓨팅(Compute Engine) 모듈을 분리하여 확장성 있는 구조를 갖춤. 특히 한정된 자원을 고려하여 e2-small 타입의 스팟 인스턴스(Spot Instance)와 관리형 인스턴스 그룹(MIG)을 결합하여 비용은 줄이되 가용성은 확보하는 전략을 수립함. 초기 GCP API 활성화 및 IAM 권한 문제를 해결하고, 도커 이미지를 빌드하여 원격 저장소에 업로드하는 배포 파이프라인의 기초를 완성함.

3. 주요 수정 및 개발 내용
Terraform 모듈화 및 구조 확립:
modules/network: VPC, Subnet, 방화벽(SSH 허용) 구축.
modules/storage: Docker 이미지를 저장할 Artifact Registry 생성.
modules/compute: Service Account 생성, IAM 권한 부여, Instance Template 및 MIG 정의.

서버 비용 최적화 (Cost Optimization):
인스턴스 사양을 e2-medium에서 e2-small로 변경하여 메모리(2GB) 확보 및 비용 절감.
provisioning_model = "SPOT" 적용 및 MIG의 Auto-healing(자동 복구) 기능을 통해 스팟 인스턴스 회수 시 즉시 새 서버가 생성되도록 구성.

Docker 환경 구성:
Dockerfile 최적화: Python 3.12-slim 베이스 이미지 사용, Timezone(KST) 설정, 불필요한 파일 제외.
.dockerignore 강화: 보안 파일(service_account.json, secret.py 등) 및 로컬 환경 파일(venv)이 이미지에 포함되지 않도록 설정 (보안 이슈 식별 후 적용 예정).

4. 시행 착오 및 오류 해결
[GCP 인증 및 권한 오류]
증상: Terraform Plan 실행 시 Default Credentials 미발견 및 403 Forbidden 에러 다수 발생.
해결: provider.tf에 credentials 파일 경로 명시 및 GCP 콘솔에서 IAM API, Compute Engine API 등 필수 API를 수동 활성화. Service Account에 '소유자(Owner)' 권한을 부여하여 초기 인프라 생성 권한 확보.

[Docker Push 실패]
증상: gcloud 명령어 인식 불가 및 Docker Daemon 연결 오류.
해결: Google Cloud SDK 설치 및 초기화(gcloud init), Docker Desktop 실행 후 configure-docker 인증 명령어를 통해 접속 권한 획득. 이미지 태그(Tag)를 원격 저장소 주소 형식에 맞춰 재생성 후 Push 성공.

[보안 취약점 식별]
문제: Docker 빌드 시 secret.py와 service_account.json이 이미지 내부에 포함될 위험 확인.
대책: 배포를 일시 중단하고, 해당 파일들을 .dockerignore에 추가함과 동시에, 코드를 수정하여 Secret Manager와 환경 변수를 사용하는 방식으로 전환하기로 결정.

5. 다음 목표
코드 리팩토링: Mervis 파이썬 코드 내의 파일 직접 참조 로직을 os.getenv를 사용한 환경 변수 참조 방식으로 전면 수정.
보안 적용: GCP Secret Manager에 실제 키 값 등록 및 Terraform을 통한 접근 권한(Secret Accessor) 부여.
최종 배포: 보안이 적용된 코드로 Docker 이미지 재빌드 및 Terraform metadata_startup_script 수정을 통한 완전한 배포 파이프라인 가동.