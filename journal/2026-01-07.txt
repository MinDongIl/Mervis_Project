[연구 일지] 2026-01-07

1. 주요 내용
자기 복기(RAG)를 통한 지능형 분석 체계 완성, 시각적 학습을 위한 동적 차트 생성(Painter) 구현, 그리고 전략 기반 다중 알림 시스템 구축.

2. 진행 요약
어제 구축한 '채점관' 시스템에 이어, 실패 원인을 분석해 DB에 '오답노트(Feedback)'를 저장하고 이를 다음 분석 프롬프트에 주입하는 **완전한 자기 복기 루프(Self-Correction)**를 완성함. 또한, 사용자의 직관적인 학습을 위해 분석 근거(RSI, 일목균형표 등)를 시각화한 차트를 자동 생성하는 mervis_painter 모듈을 개발함. 마지막으로 단일 조건만 감시하던 알림 시스템을 다중 조건(진입/목표/손절) 동시 감시 및 전략 자동 등록이 가능한 형태로 고도화함.

3. 주요 수정 및 개발 내용
자기 복기 및 지능 강화 (RAG System)

오답노트 생성: mervis_examiner.py에서 패배(LOSE)한 매매에 대해 AI 코치가 원인을 분석하고 짧고 굵은 교훈을 DB에 저장하도록 구현.

경험 주입: mervis_brain.py 분석 시, 해당 종목의 과거 실패 사례(오답노트)를 프롬프트에 포함시켜 "같은 실수를 반복하지 않도록" 지시.

실행 최적화: 채점 시스템이 하루에 한 번만 실행되도록 스케줄링 로직 추가(.examiner_last_run 활용).

동적 차트 생성 (Visual Learning)

Mervis Painter (mervis_painter.py): mplfinance를 활용하여 캔들 차트 및 주요 보조지표(이동평균선, 볼린저밴드, 일목균형표, RSI 등)를 그리는 모듈 신설.

동적 시각화: 분석 로직(mervis_brain)이 "RSI 과매도"를 근거로 삼으면 차트에 RSI를, "구름대 돌파"를 근거로 삼으면 일목균형표를 그리는 등 상황에 맞춰 차트 구성을 동적으로 변경.

고도화된 알림 시스템 (Smart Watcher)

다중 조건 감시 (kis_websocket.py): 기존 1종목 1조건 제한을 타파하여, 한 종목에 대해 [진입가, 목표가, 손절가] 리스트를 관리하도록 구조 변경. 특정 조건 달성 시 해당 조건만 삭제하고 나머지는 유지.

전략 자동 등록 (mervis_ai.py): "전략대로 설정해" 명령 시, 리포트 텍스트에서 가격 정보를 정규식으로 추출하여 3가지 조건(Buy/Target/Cut)을 일괄 등록하는 기능 추가.

문맥 인식: "300불 되면 알려줘" 같은 불완전한 명령어도 이전 대화의 종목(last_ticker)과 현재가를 기반으로 조건을 추론하여 처리.

4. 시행 착오 및 오류 해결
[코드 오류] mervis_brain.py에서 지표 계산 함수 반환값 개수(3개)와 호출부 언패킹 개수(2개) 불일치로 ValueError 발생.

[해결] 호출부에서 key_factors 변수를 추가로 받도록 수정하여 동기화.

[DB 오류] BigQuery에 오답노트 저장 시 DATETIME과 TIMESTAMP 타입 간 불일치 및 쿼리 문법 오류 발생.

[해결] 파라미터화된 쿼리(Parameterized Query)를 적용하고, 날짜 비교 시 CAST(log_date AS STRING)을 사용하여 타입 문제를 원천 차단.

[알림 오류] 알림이 한 번 울리면 종목 감시 자체가 해제되어 후속 대응(손절/익절)이 불가능했던 문제.

[해결] 감시 리스트 구조를 딕셔너리 리스트로 변경하고, 조건 달성 시 del list[index] 방식으로 해당 조건만 개별 삭제하도록 로직 개선.

5. 다음 목표
실전 데이터 축적 및 시스템 안정성 모니터링 (40개 종목 스마트 큐 동작 확인).

축적된 오답노트 데이터를 바탕으로 머비스의 승률 변화 추이 분석.